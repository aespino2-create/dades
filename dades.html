<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lectures - Portada + Full de càlcul</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--accent:#60a5fa;--glass:rgba(255,255,255,0.04)}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial, sans-serif;background:linear-gradient(180deg,#031124 0%, #062b3a 100%);color:#e6eef8}
    .center{display:flex;align-items:center;justify-content:center}

    /* Portada */
    #splash{position:fixed;inset:0;background:linear-gradient(135deg,#0b1220 0%, #062b3a 100%);z-index:50;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:18px}
    #splash img{width:min(70%,420px);max-width:90%;height:auto;filter:drop-shadow(0 10px 30px rgba(0,0,0,0.6))}
    #splash .caption{opacity:0.85;font-weight:600}

    /* App */
    .app{display:none;padding:20px;max-width:1000px;margin:24px auto}
    .card{background:var(--glass);border-radius:12px;padding:16px;box-shadow:0 6px 30px rgba(2,6,23,0.6);backdrop-filter:blur(6px)}

    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    header h1{font-size:1.25rem;margin:0}

    .controls{display:flex;flex-wrap:wrap;gap:8px}
    input[type=text]{min-width:260px;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    button{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#04233a;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit}

    .cols{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:14px}
    details{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px}
    summary{cursor:pointer;font-weight:700}
    .info{margin-top:10px;font-size:0.95rem}

    footer{margin-top:18px;font-size:0.85rem;opacity:0.8}

    @media (max-width:520px){header{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
  <!-- Portada que es veu 5 segons -->
  <div id="splash">
    <!-- SVG portada embeguda perquè funcioni offline -->
    <img alt="Portada" src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="600" viewBox="0 0 1200 600"><defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="%230b1220"/><stop offset="1" stop-color="%23062b3a"/></linearGradient></defs><rect width="100%" height="100%" fill="url(%23g)"/><g transform="translate(60,90)"><text x="0" y="80" font-size="72" font-family="Arial, Helvetica, sans-serif" fill="%23ffffff">Lectures meteorològiques</text><text x="0" y="140" font-size="28" fill="%23cfe8ff">Dades d'exemple: Tarragona — 30 lectures horàries</text></g></svg>' />
    <div class="caption">Carregant aplicació — portada (5s)</div>
  </div>

  <!-- Aplicació principal -->
  <main class="app" role="main">
    <div class="card">
      <header>
        <h1>Visualitzador de fulls de càlcul</h1>
        <div style="opacity:0.9">Pista: enganxa l'adreça pública d'un Google Sheet o carrega dades de prova</div>
      </header>

      <div class="controls">
        <input id="sheetUrl" type="text" placeholder="Enganxa l'adreça pública del full de càlcul (Google Sheets)" aria-label="Adreça del full" />
        <button id="loadBtn">Carregar</button>
        <button id="sampleBtn" class="secondary">Carregar dades de prova</button>
      </div>

      <div id="status" style="margin-top:12px;color:#d6e9ff;min-height:20px"></div>

      <div id="columns" class="cols" aria-live="polite"></div>

      <footer>
        Aquesta aplicació llegeix un CSV públic exportat des d'un Google Sheet. Si el full és privat, fes-lo públic o exporta un CSV.
      </footer>
    </div>
  </main>

  <script>
    // Mostra la portada 5 segons
    const splash = document.getElementById('splash');
    const app = document.querySelector('.app');
    setTimeout(()=>{
      splash.style.transition = 'opacity 400ms ease';
      splash.style.opacity = 0;
      setTimeout(()=>{splash.style.display='none';app.style.display='block';},450);
    },5000);

    // Utilitats
    function parseCSV(text){
      // Parser simple que maneja cometes i comes. Retorna array de arrays.
      const rows = [];
      let cur = '';
      let row = [];
      let inQuotes = false;
      for(let i=0;i<text.length;i++){
        const ch = text[i];
        if(ch==='"'){
          if(inQuotes && text[i+1]==='"'){ cur+='"'; i++; } else inQuotes = !inQuotes;
        } else if(ch==='\n' || ch==='\r'){
          if(!inQuotes){
            if(ch==='\r' && text[i+1]==='\n'){ /* skip - handled when loop reaches \n */ }
            row.push(cur); cur='';
            // only push non-empty row (handle trailing newline)
            rows.push(row); row = [];
          } else { cur += ch; }
        } else if(ch===',' && !inQuotes){ row.push(cur); cur=''; }
        else cur += ch;
      }
      // final
      if(cur!=='' || row.length>0){ row.push(cur); rows.push(row); }
      // Remove possible empty final row
      if(rows.length && rows[rows.length-1].length===1 && rows[rows.length-1][0]==='') rows.pop();
      return rows;
    }

    function toNumber(v){
      if(v==null) return NaN;
      // Remove spaces and possible unit symbols
      const cleaned = String(v).replace(/[^0-9+\-.,eE]/g,'').replace(',','.')
      return Number(cleaned);
    }

    // Loaders
    const status = document.getElementById('status');
    const columnsEl = document.getElementById('columns');
    document.getElementById('loadBtn').addEventListener('click', ()=> loadFromUrl(document.getElementById('sheetUrl').value.trim()));
    document.getElementById('sampleBtn').addEventListener('click', loadSample);

    async function loadFromUrl(url){
      if(!url){ status.textContent='Introdueix una URL.'; return; }
      status.textContent = 'Preparant carregament...';
      try{
        const csvUrl = convertToGoogleCsv(url);
        status.textContent = 'Sol·licitant dades...';
        const res = await fetch(csvUrl);
        if(!res.ok) throw new Error('No s'ha pogut descarregar (comprova permís públic).');
        const text = await res.text();
        processCsvText(text);
      }catch(err){ status.textContent = 'Error: '+err.message; }
    }

    function convertToGoogleCsv(url){
      // Detecta URL de Google Sheets i construeix export CSV.
      try{
        const u = new URL(url);
        if(u.hostname.includes('docs.google.com')){
          // Expect format /spreadsheets/d/<id>/...
          const parts = u.pathname.split('/');
          const idx = parts.indexOf('d');
          if(idx!==-1 && parts.length>idx+1){
            const id = parts[idx+1];
            // default to first sheet; users can provide &sheet=Name in URL if needed
            return `https://docs.google.com/spreadsheets/d/${id}/export?format=csv`;
          }
        }
        // Otherwise assume the URL already points to a CSV file
        return url;
      }catch(e){ return url; }
    }

    function processCsvText(text){
      const rows = parseCSV(text);
      if(rows.length<2){ status.textContent='CSV sense dades suficients.'; return; }
      const headers = rows[0].map(h=>h.trim()||'Col');
      const dataRows = rows.slice(1).filter(r => r.some(c=>c !== ''));
      status.textContent = `Carregades ${dataRows.length} files. Generant interfície...`;
      renderColumns(headers, dataRows);
    }

    function renderColumns(headers, dataRows){
      columnsEl.innerHTML='';
      // Per la sol·licitud: ignora la primera columna i crea botó per cada columna a partir de la segona
      for(let c=1;c<headers.length;c++){
        const colName = headers[c] || (`Col ${c+1}`);
        const values = dataRows.map(r=>r[c]);
        const numeric = values.map(v=>toNumber(v)).filter(v=>!Number.isNaN(v));

        const det = document.createElement('details');
        const sum = document.createElement('summary');
        sum.textContent = colName;
        det.appendChild(sum);

        const info = document.createElement('div');
        info.className='info';

        if(values.length===0){ info.innerHTML = '<div>No hi ha dades per a aquesta columna.</div>'; }
        else{
          const lastRaw = values[values.length-1];
          const lastNum = toNumber(lastRaw);
          let lastDisplay = lastRaw;
          if(!Number.isNaN(lastNum)) lastDisplay = lastNum;

          // mitjana últims 4 valors numèrics (no nuls) - mantenim ordre d'arribada
          const last4 = [];
          for(let i=values.length-1;i>=0 && last4.length<4;i--){ const n = toNumber(values[i]); if(!Number.isNaN(n)) last4.push(n); }
          const avg = last4.length>0 ? (last4.reduce((a,b)=>a+b,0)/last4.length) : NaN;

          info.innerHTML = `<div>Últim registre recollit: <strong>${escapeHtml(String(lastDisplay))}</strong></div>`+
                           `<div>Mitjana (últims ${last4.length}): <strong>${Number.isNaN(avg)?'—':avg.toFixed(2)}</strong></div>`;
        }

        det.appendChild(info);
        columnsEl.appendChild(det);
      }
    }

    // Escape HTML simple
    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Botó per carregar dades de prova
    function loadSample(){
      status.textContent='Carregant dades de prova (30 lectures horàries - Tarragona)...';
      const csv = generateSampleCsv();
      // Simulem un retard curt
      setTimeout(()=>{ processCsvText(csv); status.textContent='Dades de prova carregades.'; }, 300);
    }

    function generateSampleCsv(){
      // Genera 30 lectures horàries acabant ara. Primera columna: timestamp ISO local, segona: temperatura, tercera: humitat
      const rows = [];
      const header = ['timestamp','temperatura_C','humitat_percent'];
      rows.push(header.join(','));
      const now = new Date();
      // Generem valors típics per Tarragona a mitjans d'octubre: temperatura 12-24, humitat 55-90
      for(let i=29;i>=0;i--){
        const d = new Date(now.getTime() - i*60*60*1000);
        const hh = d.toLocaleString('sv-SE', { timeZoneName:'short' }).slice(11,19); // not critical
        // Create smoother diurnal variation: use sine
        const hour = d.getHours();
        // base temp
        const base = 17; // mitjana
        const amp = 6; // amplitud
        const temp = base + amp * Math.sin((hour/24)*2*Math.PI - 0.5) + (Math.random()-0.5)*1.5;
        const humBase = 72 - (temp-17)*1.2; // inverse correlation
        const hum = Math.max(40, Math.min(95, humBase + (Math.random()-0.5)*6));
        rows.push(`${d.toISOString()},${temp.toFixed(2)},${hum.toFixed(1)}`);
      }
      return rows.join('\n');
    }

    // Small UX: expand <details> when clicked on the summary to focus
    columnsEl.addEventListener('click', (e)=>{
      const el = e.target.closest('details');
      if(el) el.open = !el.open;
    });

    // For demonstration, autopopulate sample after load? We keep it manual.
  </script>
</body>
</html>
